pipeline {
    agent any

    environment {
        REGISTRY = "local"
        COMPOSE_FILE = "../docker-compose.yml"
        LOAD_SCRIPT = "../load_images.sh"
        K8S_MANIFEST = "../k8s-optimized.yml"
        NAMESPACE = "ecommerce-microservices"
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Clonando repositorio..."
                checkout scm
            }
        }

        stage('Build Docker Images') {
            steps {
                echo "Construyendo imágenes Docker..."
                sh "docker compose -f ${COMPOSE_FILE} build"
            }
        }

        stage('Load Images to Minikube') {
            steps {
                echo "Cargando imágenes en Minikube..."
                sh "${LOAD_SCRIPT}"
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                echo "Desplegando microservicios en Minikube..."
                sh "kubectl apply -f ${K8S_MANIFEST}"
            }
        }

        stage('Verify Deployment') {
            steps {
                echo "Verificando que los pods estén corriendo..."
                sh "kubectl get pods -n ${NAMESPACE}"
            }
        }
    }

    post {
        success {
            echo "✅ Despliegue completado exitosamente."
        }
        failure {
            echo "❌ Error durante el pipeline."
        }
    }
}
