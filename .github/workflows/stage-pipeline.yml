name: Stage Pipeline - Integration Tests & Deploy

on:
  workflow_run:
    workflows: ["Development CI Pipeline"]
    types:
      - completed
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      force_recreate_minikube:
        description: 'Force recreate Minikube cluster'
        required: false
        default: false
        type: boolean

jobs:
  stage-deploy:
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    env:
      COMPOSE_FILE: ./compose.yml
      LOAD_SCRIPT: ./load-images-minikube.bat
      DEPLOY_SCRIPT: ./deploy-individual-services.bat
      NAMESPACE: ecommerce-microservices

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Run Integration Tests
        shell: powershell
        run: |
          Write-Host "Running integration tests for microservices communication..."
          
          $services = @("user-service", "order-service", "product-service", "payment-service", "shipping-service")
          
          foreach ($service in $services) {
            if (Test-Path "$service/src/test/java") {
              Write-Host "Running integration tests for $service..."
              cd $service
              mvn test -Dtest="*IntegrationTest" -Dspring.profiles.active=test -Dmaven.test.failure.ignore=true
              cd ..
            }
          }
          
          Write-Host "Integration tests completed!"

      - name: Check if Minikube exists
        id: check_minikube
        shell: powershell
        run: |
          try {
            $status = minikube status 2>$null
            if ($status -match "Running") {
              Write-Host "Minikube is running"
              echo "minikube_exists=true" >> $env:GITHUB_OUTPUT
            } else {
              Write-Host "Minikube exists but is not running"
              echo "minikube_exists=false" >> $env:GITHUB_OUTPUT
            }
          } catch {
            Write-Host "Minikube does not exist"
            echo "minikube_exists=false" >> $env:GITHUB_OUTPUT
          }

      - name: Clean existing Minikube namespace and images
        if: steps.check_minikube.outputs.minikube_exists == 'true' && github.event.inputs.force_recreate_minikube != 'true'
        shell: powershell
        run: |
          Write-Host "Cleaning namespace and existing resources..."
          
          kubectl delete namespace $env:NAMESPACE --ignore-not-found=true
          
          do {
            $ns = kubectl get namespace $env:NAMESPACE --ignore-not-found=true 2>$null
            if (-not $ns) { break }
            Write-Host "Waiting for namespace to be deleted..."
            Start-Sleep -Seconds 5
          } while ($true)
          
          Write-Host "Removing previous images from Minikube..."
          minikube image rm ecommerce/user-service:latest --ignore-not-found
          minikube image rm ecommerce/order-service:latest --ignore-not-found  
          minikube image rm ecommerce/product-service:latest --ignore-not-found
          minikube image rm ecommerce/payment-service:latest --ignore-not-found
          minikube image rm ecommerce/shipping-service:latest --ignore-not-found
          minikube image rm ecommerce/api-gateway:latest --ignore-not-found
          minikube image rm ecommerce/service-discovery:latest --ignore-not-found
          minikube image rm ecommerce/cloud-config:latest --ignore-not-found
          
          Write-Host "Cleanup completed!"

      - name: Create or recreate Minikube
        if: steps.check_minikube.outputs.minikube_exists == 'false' || github.event.inputs.force_recreate_minikube == 'true'
        shell: powershell
        run: |
          if ("${{ github.event.inputs.force_recreate_minikube }}" -eq "true") {
            Write-Host "Recreating Minikube as requested..."
            minikube delete --purge
          }
          
          Write-Host "Creating new Minikube cluster..."
          minikube start --memory=12974 --cpus=4 --driver=docker
          
          $status = minikube status
          if ($status -match "Running") {
            Write-Host "Minikube created and running correctly"
          } else {
            Write-Host "Error creating Minikube"
            exit 1
          }

      - name: Build fresh Docker images
        shell: powershell
        run: |
          Write-Host "Building fresh Docker images..."
          docker compose -f $env:COMPOSE_FILE build --no-cache
          Write-Host "Images built successfully!"

      - name: Load new images into Minikube
        shell: powershell
        run: |
          Write-Host "Loading new images into Minikube..."
          & $env:LOAD_SCRIPT
          
          Write-Host "Verifying loaded images:"
          minikube image ls | findstr "ecommerce"

      - name: Deploy to Kubernetes
        shell: powershell
        run: |
          Write-Host "Deploying services to Kubernetes..."
          
          kubectl create namespace $env:NAMESPACE --dry-run=client -o yaml | kubectl apply -f -
          
          if (Test-Path "k8s-optimized.yaml") {
            kubectl apply -f k8s-optimized.yaml
          } elseif (Test-Path "k8s/") {
            kubectl apply -f k8s/
          } else {
            Write-Host "Kubernetes manifests not found"
            exit 1
          }

      - name: Wait for pods to be ready
        shell: powershell
        run: |
          Write-Host "Waiting for all pods to be ready..."
          kubectl wait --for=condition=ready pod --all -n $env:NAMESPACE --timeout=600s
          
          Write-Host "Final pod status:"
          kubectl get pods -n $env:NAMESPACE
          
          Write-Host "Available services:"
          kubectl get svc -n $env:NAMESPACE

      - name: Run E2E Tests (placeholder)
        shell: powershell
        run: |
          Write-Host "Running E2E tests..."
          Write-Host "Placeholder for end-to-end tests"
          Write-Host "Here we would run tests against deployed services"
          
          try {
            $apiGatewayUrl = minikube service api-gateway-service -n $env:NAMESPACE --url
            Write-Host "API Gateway available at: $apiGatewayUrl"
          } catch {
            Write-Host "Could not get API Gateway URL"
          }
          
          Write-Host "E2E tests completed!"

      - name: Generate Stage Report
        if: always()
        shell: powershell
        run: |
          Write-Host "Stage Pipeline Report:"
          Write-Host "=================================="
          Write-Host "Integration Tests: Executed"
          $minikubeStatus = "${{ steps.check_minikube.outputs.minikube_exists }}"
          if ($minikubeStatus -eq "true") {
            Write-Host "Minikube: Cleaned and updated"
          } else {
            Write-Host "Minikube: Created from scratch"
          }
          Write-Host "Docker Images: Built and loaded"
          Write-Host "Kubernetes Deploy: Completed"
          Write-Host "Pods Status: ${{ job.status }}"
          Write-Host ""
          Write-Host "Stage environment ready for manual testing!"
          Write-Host "Access services using:"
          Write-Host "minikube service api-gateway-service -n ecommerce-microservices"